---

name: quiz-answer-redistributor
description: |
  Fixes answer key bias in existing quiz .md files with intelligent explanation regeneration.
  Reads a quiz .md file (with any number of questions) generated by 'quiz-generator',
  parses the 'questions' array from the MDX, and programmatically re-distributes
  the 'correctOption' indices to match a pre-defined, non-biased sequence (A-H).
  CRITICALLY: Also intelligently regenerates explanations to match swapped answer positions
  (prevents dangerously incorrect explanations where explanation praises wrong answers).
  Validates all explanations for mismatches between correctOption and explanation content.
  Uses bundled Python scripts (redistribute_answers_v2.py primary, redistribute_answers.py fallback)
  to handle complex MDX parsing, AI-powered explanation regeneration, and automatic validation.
allowed-tools: [Bash]
version: 3.0.0
---

# Quiz Answer Re-Distributor

**Version:** 3.0.0 | **Purpose:** Complete Quiz Answer Redistribution with Intelligent Explanation Regeneration and Validation**

---

## 1. Purpose

The `quiz-generator` skill is an LLM designed for high-quality **content creation**. However, LLMs are not good at following strict mathematical or procedural constraints over a long task, which often results in a **biased answer key** (e.g., "Option B" is correct 40% of the time).

**THE CRITICAL PROBLEM SOLVED BY v3.0:**
When answer options are physically shuffled to fix bias, the original explanations become **dangerously incorrect**. For example:
- Original: "Option B is correct because..." (now in position D after shuffle)
- Without explanation update: The explanation now praises a distractor option, creating student confusion or misinformation

This skill solves this by:
1.  Reading the quiz `.md` file generated by `quiz-generator` (which can have 36, 48, 50, or any number of questions).
2.  Parsing the `questions` array from the MDX component.
3.  Loading one of the 8 pre-made, 50-item sequences (see Section 4).
4.  **Swapping both options AND their corresponding explanations** to match the chosen sequence.
5.  **Intelligently regenerating explanations** to reference the new correct answer position.
6.  **Validating all explanations** to ensure correctOption and explanation content match.
7.  Saving the fully corrected file.

This separates "content creation" (Skill 1) from "procedural validation" (Skill 2), ensuring 100% compliance with quality standards AND pedagogical correctness.

---

## 2. When to Activate

Activate this skill **immediately after** `quiz-generator` has created a quiz file. This skill is the *second* step in a two-step process.

**Do NOT** use this skill to create new questions.

**Trigger phrases:**
- "Fix the answer distribution for `02_chapter_02_quiz.md`."
- "The quiz is generated. Now, apply **Sequence A** to normalize the answers."
- "Run the re-distributor on the quiz file I just created."
- "Shuffle the answers in `05_chapter_04_quiz.md` to match Sequence C."

---

## 3. Core Workflow

This skill executes the Python implementation script (`scripts/redistribute_answers.py`) via the `Bash` tool.

**Step 1: User Input**
- **User provides:**
    1.  The path to the quiz file (e.g., `book-source/docs/01-Introducing-AI-Driven-Development/02-ai-turning-point/05_chapter_02_quiz.md`)
    2.  The sequence letter to apply (e.g., "C")

**Step 2: Execute Redistribution Script**
- Invoke the script using Bash:
    ```bash
    python .claude/skills/quiz-answer-redistributor/scripts/redistribute_answers.py <quiz_file_path> <sequence_letter>
    ```
- The script performs all logic automatically:
    1.  **Reads** the quiz file
    2.  **Parses** the `questions` array from the MDX markup
    3.  **Loads** the specified 50-value sequence (A-H)
    4.  **Applies** the swap logic (detailed below)
    5.  **Writes** the updated file back to disk
    6.  **Reports** verification statistics

**Step 3: Verification**
- The script automatically counts and reports the final distribution
- Compare against the expected distribution for the chosen sequence
- Output format shows total questions and count for each index (0-3)

### The Swap Logic (Inside the Script)

This is the most critical part. For each question `i`:

1.  **Get Current Index:** Find the *current* correct answer.
    * `currentIndex = questions[i].correctOption`
    * (e.g., `currentIndex` might be `1` from the biased generator)

2.  **Get Target Index:** Get the *new, correct* index from the pre-made sequence.
    * `targetIndex = sequence[i]`
    * (e.g., the sequence says this question *must* be `2`)
    * **Note:** This naturally handles variable lengths. If there are 36 questions, this will only use `sequence[0]` through `sequence[35]`.

3.  **Check:** If `currentIndex` is already the same as `targetIndex`, do nothing.

4.  **Swap:** If they are different:
    * Get the text of the correct answer: `correctAnswerText = questions[i].options[currentIndex]`
    * Get the text of the option at the target spot: `otherAnswerText = questions[i].options[targetIndex]`
    * **Perform the swap:**
        * `questions[i].options[targetIndex] = correctAnswerText`
        * `questions[i].options[currentIndex] = otherAnswerText`
    * **Update the index:**
        * `questions[i].correctOption = targetIndex`

---

## 4. Pre-Made Distribution Lists (Source of Truth)

This skill MUST use the same 50-item sequences as `quiz-generator`. The script will only use the first `N` values, where `N` is the number of questions in the file.

### Distribution Sequences (Pre-Made, Pre-Verified)

**OPTION A (Distribution: 13 Index-0, 13 Index-1, 12 Index-2, 12 Index-3)**
```

2,0,3,1,2,0,1,3,2,0,1,3,0,2,1,3,2,0,1,3,0,2,3,1,0,2,3,1,2,0,3,1,2,0,1,3,0,2,3,1,2,0,3,1,0,2,1,3,0,2

```

**OPTION B (Distribution: 12 Index-0, 13 Index-1, 13 Index-2, 12 Index-3)**
```

1,3,0,2,1,3,0,2,3,1,0,2,3,1,2,0,1,3,2,0,3,1,2,0,1,3,0,2,1,3,2,0,3,1,0,2,3,1,2,0,1,3,0,2,1,0,3,2,1,3

```

**OPTION C (Distribution: 12 Index-0, 12 Index-1, 13 Index-2, 13 Index-3)**
```

3,2,1,0,3,2,1,0,2,3,0,1,3,2,0,1,2,3,1,0,3,2,0,1,2,3,1,0,3,2,1,0,2,3,0,1,3,2,1,0,2,3,0,1,3,2,0,1,3,2

```

**OPTION D (Distribution: 13 Index-0, 12 Index-1, 12 Index-2, 13 Index-3)**
```

0,3,2,1,0,3,2,1,3,0,2,1,0,3,1,2,0,3,2,1,0,3,1,2,3,0,1,2,0,3,2,1,3,0,1,2,0,3,1,2,3,0,2,1,0,3,1,2,3,0

```

**OPTION E (Distribution: 12 Index-0, 13 Index-1, 12 Index-2, 13 Index-3)**
```

1,2,3,0,1,2,3,0,2,1,3,0,1,2,0,3,1,2,3,0,1,2,0,3,2,1,3,0,1,2,3,0,2,1,0,3,1,2,3,0,2,1,0,3,2,1,3,0,1,2

```

**OPTION F (Distribution: 13 Index-0, 12 Index-1, 13 Index-2, 12 Index-3)**
```

2,3,0,1,2,3,0,1,3,2,1,0,2,3,0,1,3,2,0,1,2,3,1,0,3,2,1,0,2,3,0,1,3,2,1,0,2,3,1,0,3,2,0,1,2,3,1,0,3,2

```

**OPTION G (Distribution: 12 Index-0, 13 Index-1, 13 Index-2, 12 Index-3 - Alternative)**
```

0,1,2,3,0,1,2,3,1,0,3,2,0,1,3,2,0,1,2,3,1,0,2,3,0,1,3,2,1,0,2,3,0,1,2,3,1,0,3,2,1,0,2,3,1,0,3,2,0,1

```

**OPTION H (Distribution: 13 Index-0, 12 Index-1, 12 Index-2, 13 Index-3 - Alternative)**
```

3,0,1,2,3,0,1,2,0,3,2,1,3,0,2,1,3,0,1,2,3,0,2,1,0,3,2,1,3,0,1,2,0,3,1,2,3,0,2,1,0,3,1,2,3,0,2,1,3,0

```
---

## 5. Implementation

### Primary Script: `scripts/redistribute_answers_v2.py`

This is the production script with full explanation regeneration and validation:

1.  **Loads all 8 sequences (A-H)** as module-level constants
2.  **Reads the quiz file** into memory
3.  **Locates the questions array** using string boundary detection (`questions={[` and `  ]}`)
4.  **Parses question blocks** using a state machine that tracks brace depth
5.  **Extracts field values** (question, options, correctOption, explanation, source) with escaped quote handling
6.  **For each swapped question:**
    - Swaps option text at indices `current_index` and `target_index`
    - Calls `regenerate_explanation()` to intelligently update explanation
    - Updates `correctOption` index
7.  **Explanation Regeneration (Smart, Non-Invasive):**
    - **Detects** if explanation contains explicit option references (e.g., "Option A", "(B)")
    - **If NO option references found:** Returns explanation unchanged (context-based explanations are valid and don't need updates)
    - **If option references found:** Intelligently updates them to match new answer position
    - **Never adds** annotation markers like "[Updated to reflect...]" (keeps explanations clean for students)
    - Preserves pedagogical quality and maintains complete student experience
8.  **Validation Phase (SMART):**
    - For EACH question, validates intelligently:
      - `correctOption` index is valid (0-3)
      - **If explanation has NO option references:** Mark as VALID (context-based approach is fine)
      - **If explanation HAS option references:** Ensure they match the correct option letter
      - Explanation doesn't reference wrong options as correct
    - Reports matches with specific question numbers
    - Flags for manual review only if there are actual issues
9.  **Rebuilds the array** in original MDX format
10. **Writes back to file** and reports comprehensive statistics

**Key Implementation Characteristics:**

- **No regex for complex parsing:** Uses string methods and brace-depth tracking
- **Safe field extraction:** Handles escaped quotes and newlines
- **Non-invasive explanation updates:** Only updates explanations that explicitly reference option letters; leaves context-based explanations untouched
- **No annotation markers:** Never adds "[Updated to reflect...]" or similar markers - keeps explanations clean for students
- **Smart validation:** Only flags explanations as invalid if they contain option references that don't match the correct answer
- **Comprehensive yet reasonable validation:** Checks every explanation intelligently, not just mechanically
- **Variable quiz lengths:** Works with 36, 48, 49, 50+ questions
- **Helpful reporting:** Detailed messages for validation results with clear distinction between "valid context-based" and "valid option-referenced" explanations

### Fallback Script: `scripts/redistribute_answers.py`

Available as fallback for situations where explanation regeneration is not needed.

**Usage (Primary v2):**

```bash
python .claude/skills/quiz-answer-redistributor/scripts/redistribute_answers_v2.py <quiz_file_path> <sequence_letter>
```

Example:
```bash
python .claude/skills/quiz-answer-redistributor/scripts/redistribute_answers_v2.py book-source/docs/01-Introducing-AI-Driven-Development/02-ai-turning-point/05_chapter_02_quiz.md C
```

**Output Includes:**
- Extraction confirmation (number of questions parsed)
- Original distribution statistics
- Number of swaps applied
- Number of explanations updated
- Validation results for EACH question
- Final distribution matching sequence
- Summary of any issues requiring manual review

---

## 6. Handoff Criteria

This skill is complete when:
- [x] Primary script (`scripts/redistribute_answers_v2.py`) created with full explanation regeneration
- [x] Script successfully swaps options AND regenerates explanations
- [x] Script intelligently updates explanation references (Option A → Option D, etc.)
- [x] Validation phase checks EVERY explanation for correctness
- [x] Script detects mismatches between correctOption and explanation content
- [x] Fallback script available for option-only swaps if needed
- [x] All output clearly indicates validation results (pass/fail per question)
- [x] Flags questions requiring manual review with specific issue descriptions

**Skill Usage Workflow:**

1. User invokes skill with: `Shuffle the answers in <quiz_file> to match Sequence <letter>`
2. Claude extracts file path and sequence letter
3. Claude invokes Bash: `python .claude/skills/quiz-answer-redistributor/scripts/redistribute_answers_v2.py <path> <letter>`
4. Script executes: parses → swaps → regenerates → validates
5. Claude displays full report including validation results
6. If validation issues, Claude flags them and recommends manual review

**Example Handoff Message (Successful validation):**
> Successfully re-distributed `05_chapter_02_quiz.md` using **Sequence C**
>
> **Execution Summary:**
> * Questions Processed: 49
> * Options Swapped: 15
> * Explanations Updated: 15
> * Validation: ALL CHECKS PASSED
>
> **Final Distribution:**
> * Index 0: 12
> * Index 1: 12
> * Index 2: 12
> * Index 3: 13
>
> All 49 explanations verified. Each explanation correctly references the corresponding correct answer option.

**Example Handoff Message (With validation issues):**
> Re-distributed `05_chapter_02_quiz.md` using **Sequence C**
>
> **Execution Summary:**
> * Questions Processed: 49
> * Options Swapped: 15
> * Explanations Updated: 15
> * Validation: 2 ISSUES FOUND
>
> **Validation Issues (Require Manual Review):**
> * Question 7: Explanation doesn't reference Option A (correctOption=0)
> * Question 23: Explanation references Option B as correct but correctOption=3
>
> **Recommendation:** Manually review and update explanations for questions 7 and 23.
